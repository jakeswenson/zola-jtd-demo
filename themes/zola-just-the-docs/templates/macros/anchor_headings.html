{# <!--
Version 1.0.3
https://github.com/allejo/jekyll-anchor-headings

"Be the pull request you wish to see in the world." ~Ben Balter

Usage:
{% include anchor_headings.html html=content %}

Parameters:
* html          (string) - the HTML of compiled markdown generated by kramdown in Jekyll

Optional Parameters:
* beforeHeading (bool)   : false  - Set to true if the anchor should be placed _before_ the heading's content
* anchorBody    (string) :  ''    - The content that will be placed inside the anchor; the `%heading%` placeholder is available
* anchorClass   (string) :  ''    - The class(es) that will be used for each anchor. Separate multiple classes with a space
* anchorTitle   (string) :  ''    - The `title` attribute that will be used for anchors
* h_min         (int)    :  1     - The minimum header level to build an anchor for; any header lower than this value will be ignored
* h_max         (int)    :  6     - The maximum header level to build an anchor for; any header greater than this value will be ignored
* bodyPrefix    (string) :  ''    - Anything that should be inserted inside of the heading tag _before_ its anchor and content
* bodySuffix    (string) :  ''    - Anything that should be inserted inside of the heading tag _after_ its anchor and content

Output:
The original HTML with the addition of anchors inside of all of the h1-h6 headings.
--> #}
{% macro build(min_header=1, max_header=6, before_heading=false, html, anchor_class='', anchor_title='', anchor_body='', body_prefix='', body_suffix='') -%}
  {% set nodes = html | split(pat='<h') -%}
  {# <!-- nodes: {{ nodes |json_encode | safe }} --> #}
  {%- set edited_headings = '' -%}

  {% for _node in nodes -%}
    {% set node = _node | trim -%}

    {% if node == "" -%}
      {% continue -%}
    {% endif -%}
    {# <!-- node: {{ node |json_encode | safe }} --> #}

    {%- set nextChar = node | split(pat='') | nth(n=1) -%}
    {# <!-- nextChar: {{ nextChar |json_encode | safe }} --> #}
    {%- set headerLevel = nextChar | int -%}
    {# <!-- headerLevel: {{ headerLevel |json_encode | safe }} --> #}
    {# <!--  If the level is cast to 0, it means it's not a h1-h6 tag, so let's try to fix it --> #}
    {%- if headerLevel == 0 -%}
      {% if nextChar != '<' and nextChar != '' -%}
        {% set node = '<h' ~  node -%}
      {% endif -%}

      {% set_global edited_headings = edited_headings ~ node -%}
      {% continue -%}
    {% endif -%}

    {%- set _workspace = node | split(pat='</h') -%}
    {# <!-- workspace: {{ _workspace |json_encode | safe }} --> #}
    {%- set _idWorkspace = _workspace | first | split(pat='id="') -%}
    {% set _idWorkspace = _idWorkspace | nth(n=1) | split(pat='"') -%}
    {% set html_id = _idWorkspace[0] -%}
    {# <!-- html_id: {{ html_id |json_encode | safe }} --> #}

    {%- set _hAttrToStrip = _workspace[0] | split(pat='>') | first -%}
    {% set _hAttrToStrip = _hAttrToStrip ~ '>' -%}
    {# <!-- _hAttrToStrip: {{ _hAttrToStrip |json_encode | safe }} --> #}
    {%- set header = _workspace[0] | replace(from=_hAttrToStrip,to='') -%}
    {# <!-- header: {{ header |json_encode | safe }} --> #}

    {%- set anchor = '' -%}

    {% if html_id and headerLevel >= min_header and headerLevel <= max_header -%}
      {% set anchor = 'href="#' ~ html_id ~ '"' -%}

      {% if anchor_class -%}
        {% set anchor = anchor ~ ' class="' ~ anchor_class ~ '"' -%}
      {% endif -%}

      {% if anchor_title -%}
        {% set _anchor_title = anchor_title | replace(from='%heading%',to=header) -%}
        {% set anchor = anchor ~ ' title="' ~  _anchor_title ~ '"' -%}
      {% endif -%}

      {% set _anchor_body = anchor_body | replace(from='%heading%',to=header) -%}
      {% set anchor = '<a ' ~ anchor ~ '>' ~ _anchor_body ~ '</a>' -%}

      {# In order to prevent adding extra space after a heading, we'll let the 'anchor' value contain it #}
      {%- if before_heading -%}
        {% set anchor = anchor ~ ' ' -%}
      {% else -%}
        {% set anchor = ' ' ~ anchor -%}
      {% endif -%}
    {% endif -%}

    {% if before_heading -%}
      {% set _heading = anchor ~ header -%}
    {% else -%}
      {% set _heading = header ~ anchor -%}
    {% endif -%}
    {% set _remainder = _workspace | last -%}
    {% set new_heading = ['<h', _hAttrToStrip, body_prefix, _heading, body_suffix, '</h', _remainder ] -%}
    {% set new_heading = new_heading | join(sep='') -%}
    {% set_global edited_headings = edited_headings ~ new_heading -%}
  {% endfor -%}
  {{ edited_headings | trim | safe -}}
{% endmacro add_anchors %}
